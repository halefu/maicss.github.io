<!DOCTYPE HTML>
<html>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c252cedcb208dcc2157f54d7108d1cf";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>vagrantbox制作教程 | Maic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="Maicss">
  
  
    <meta name="description" content="本文应该算是这篇文章的中译版吧。
上篇文章说了创建的事情以后再说，但是我就是一个喜欢没事就升级的人，看着那么多的1404的Ubuntu不爽，就是想升级。
然后有天打开虚拟机的时候，上面提示说1604出来了，可以升级，然后我就手贱升级了，然后，然后就是打不开了….
然后我决定自己弄一个，放到网盘上，速度也快，把自己的环境配好再打包，多爽。然后就有了这篇文章。
定义手动创建的box默认会被命名为pac">
  
  <meta name="description" content="本文应该算是这篇文章的中译版吧。
上篇文章说了创建的事情以后再说，但是我就是一个喜欢没事就升级的人，看着那么多的1404的Ubuntu不爽，就是想升级。
然后有天打开虚拟机的时候，上面提示说1604出来了，可以升级，然后我就手贱升级了，然后，然后就是打不开了….
然后我决定自己弄一个，放到网盘上，速度也快，把自己的环境配好再打包，多爽。然后就有了这篇文章。
定义手动创建的box默认会被命名为pac">
<meta property="og:type" content="article">
<meta property="og:title" content="vagrantbox制作教程">
<meta property="og:url" content="http://maicss.com/2016/08/10/vagrantbox制作教程/index.html">
<meta property="og:site_name" content="Maic">
<meta property="og:description" content="本文应该算是这篇文章的中译版吧。
上篇文章说了创建的事情以后再说，但是我就是一个喜欢没事就升级的人，看着那么多的1404的Ubuntu不爽，就是想升级。
然后有天打开虚拟机的时候，上面提示说1604出来了，可以升级，然后我就手贱升级了，然后，然后就是打不开了….
然后我决定自己弄一个，放到网盘上，速度也快，把自己的环境配好再打包，多爽。然后就有了这篇文章。
定义手动创建的box默认会被命名为pac">
<meta property="og:updated_time" content="2016-08-10T13:01:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="vagrantbox制作教程">
<meta name="twitter:description" content="本文应该算是这篇文章的中译版吧。
上篇文章说了创建的事情以后再说，但是我就是一个喜欢没事就升级的人，看着那么多的1404的Ubuntu不爽，就是想升级。
然后有天打开虚拟机的时候，上面提示说1604出来了，可以升级，然后我就手贱升级了，然后，然后就是打不开了….
然后我决定自己弄一个，放到网盘上，速度也快，把自己的环境配好再打包，多爽。然后就有了这篇文章。
定义手动创建的box默认会被命名为pac">
  
    <link rel="alternate" href="/atom.xml" title="Maic" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-70116787-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Maic</a></h1>
    <p><a href="/">FEE maicss@foxmail.com</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/others">NoName</a></li>
      
        <li><a href="/pics">Pics</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/08/10/vagrantbox制作教程/">
  <time datetime="2016-08-10T12:56:02.000Z">
    2016-08-10
  </time>
</a>
    
    
  
    <h1 class="title">vagrantbox制作教程</h1>
  

  </header>
  
  <div class="entry">
    
      <p>本文应该算是<a href="https://blog.engineyard.com/2014/building-a-vagrant-box" target="_blank" rel="external">这篇文章</a>的中译版吧。</p>
<p>上篇文章说了创建的事情以后再说，但是我就是一个喜欢没事就升级的人，看着那么多的1404的Ubuntu不爽，就是想升级。</p>
<p>然后有天打开虚拟机的时候，上面提示说1604出来了，可以升级，然后我就手贱升级了，然后，然后就是打不开了….</p>
<p>然后我决定自己弄一个，放到网盘上，速度也快，把自己的环境配好再打包，多爽。然后就有了这篇文章。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>手动创建的box默认会被命名为<code>package.box</code>。<br><a id="more"></a><br>一个<code>package.box</code>一般包括了：</p>
<ul>
<li>Vagrantfile  配置文件，使用vagrant的应该知道，就在文件夹的根目录。这个是覆盖默认的vagrant文件用的。</li>
<li>box-disk.vmdk 虚拟硬盘</li>
<li>box.ovf 虚拟硬件</li>
<li>metadata.json box的运行依赖，这个会因平台的不同变化，具体说明<a href="http://docs.vagrantup.com/v2/vmware/boxes.html" target="_blank" rel="external">在这</a></li>
</ul>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>必备条件在上一篇文章说过了，也有连接，这里就不给连接了。</p>
<ul>
<li>virtualbox</li>
<li>vagrant</li>
<li>ubuntu server 本教程使用这个作为示例。建议使用<a href="https://help.ubuntu.com/community/Installation/MinimalCD#A64-bit_PC_.28amd64.2C_x86_64.29_.28Recommended.29" target="_blank" rel="external">minimal</a>版本</li>
</ul>
<p>使用镜像创建一个虚拟机。</p>
<p>如何创建虚拟机这里就不再赘述<del>以后有时间可能会加上</del>。</p>
<p>创建的虚拟机的要求：</p>
<ul>
<li>名称： vagrant-ubuntu64（这个是自定义，没有要求，但是本教程统一使用这个）</li>
<li>类型: Linux</li>
<li>版本: Ubuntu64</li>
<li>内存: 512MB</li>
<li>虚拟磁盘: [类型: VMDK, 大小: 40 GB]</li>
<li>这里是注释：下面的设置是创建之后才能修改的</li>
<li>禁用音频</li>
<li>禁用 USB</li>
<li>网卡1设置为NAT</li>
<li>添加端口转发规则，参数为：[名称: SSH, 协议: TCP, 主机IP: blank, 主机端口: 2222, 客户IP: blank, 客户端口: 22]（在网卡1的高级里设置）</li>
</ul>
<p>然后添加镜像文件到虚拟光驱，启动虚拟机，安装ubuntu。</p>
<h2 id="虚拟机配置"><a href="#虚拟机配置" class="headerlink" title="虚拟机配置"></a>虚拟机配置</h2><blockquote>
<p>以下的选做选项建议新手必做。下面的命令有的是不一定是一句，有的要分开执行，别直接复制粘贴敲回车。</p>
</blockquote>
<p>1，root用户密码：vagrant，选做。<br>2，规定了root权限是不需要密码的，所以要禁用权限验证。必做。<code>sudo visudo -f /etc/sudoers.d/vagrant</code>，在打开的文件中添加：<code>vagrant ALL=(ALL) NOPASSWD:ALL</code>。这样<code>/etc/sudoers.d/</code>文件夹就属于超级用户了，就不需要权限验证了（可以用一个需要超级用户的命令测试一下）。<br>3，更新系统，选做。<code>sudo apt-get update -y sudo apt-get upgrade -y</code>，如果有更新，就重启一下再进行下面的操作。<br>4，安装密钥，必须，而且要用指定的pub。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir -p /home/vagrant/.ssh</div><div class="line">chmod 0700 /home/vagrant/.ssh</div><div class="line">wget --no-check-certificate \</div><div class="line">    https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub \</div><div class="line">    -O /home/vagrant/.ssh/authorized_keys</div><div class="line">chmod 0600 /home/vagrant/.ssh/authorized_keys</div><div class="line">chown -R vagrant /home/vagrant/.ssh</div></pre></td></tr></table></figure></p>
<p>5，安装和设置SSH，必做。</p>
<p>安装：<code>sudo apt-get install -y openssh-server</code>。如果在虚拟机安装的时候已经选择安装SSH或者镜像默认就包含了SSH就不用输入这个了。</p>
<p>编辑SSH配置：<code>sudo nano /etc/ssh/sshd_config</code>。配置如果没有就添加，有的话确保没被注释：<code>AuthorizedKeysFile %h/.ssh/authorized_keys</code>。</p>
<p>然后重启SSH服务：<code>sudo service ssh restart</code></p>
<p>6，安装virtualbox的增强模块，必做。共享文件夹必须安装这个，还能“增强手势操作和系统稳定性”。<br><code>sudo apt-get install -y gcc build-essential linux-headers-server</code>。<br>然后在虚拟机菜单栏上点击  设备–&gt; 安装增强功能，加载镜像（这玩意也是个镜像）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo mount /dev/cdrom /mnt </div><div class="line">cd /mnt</div><div class="line">sudo ./VBoxLinuxAdditions.run</div></pre></td></tr></table></figure></p>
<h2 id="生成package-box"><a href="#生成package-box" class="headerlink" title="生成package.box"></a>生成package.box</h2><p>终于走到这一步了。</p>
<p>1，先打包（官方叫这玩意为“zero out”）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo dd if=/dev/zero of=/EMPTY bs=1M</div><div class="line">sudo rm -f /EMPTY</div></pre></td></tr></table></figure></p>
<p>这样就会在你的virtual的镜像目录下产生一个<code>package.box</code>文件（不是安装目录）。</p>
<p>然后使用这个命令把名字注册进vagrant并验证配置：<code>vagrant package --base vagrant-ubuntu64</code>。这个命令的输出大概是这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">→ vagrant package --base vagrant-ubuntu64</div><div class="line">[vagrant-ubuntu64] Attempting graceful shutdown of VM...</div><div class="line">[vagrant-ubuntu64] Forcing shutdown of VM...</div><div class="line">[vagrant-ubuntu64] Clearing any previously set forwarded ports...</div><div class="line">[vagrant-ubuntu64] Exporting VM...</div><div class="line">[vagrant-ubuntu64] Compressing package to: /somepath/virtual_boxes/package.box</div></pre></td></tr></table></figure>
<p>（建议这一步在其他文件夹下操作，先把package.box拷贝到你想在那个文件夹使用vagrant的地方，这样控制配置和运行就分开了。）</p>
<h2 id="测试生成的box"><a href="#测试生成的box" class="headerlink" title="测试生成的box"></a>测试生成的box</h2><p>看这个教程的人肯定都会用了，我就不罗嗦了，直接放命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vagrant box add ubuntu64 package.box</div><div class="line">vagrant init ubuntu64</div><div class="line">vagrant up</div></pre></td></tr></table></figure>
<p>完成之后，如果是*nix系，直接<code>vagrant ssh</code>，如果是Windows就用Xshell连接，具体看上一篇文章。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>这玩意是一个公司（Hashicorp）做的，他们是有收费的项目的（不然人吃什么。。。）。</p>
<p>上面的这些步骤都可以一件配置的，但是是收费的，这个工具是这个公司下的一个叫<code>packer</code>的工具，<a href="https://www.packer.io/" target="_blank" rel="external">这是地址</a>。不得不说，做的蛮不错的。</p>
<p>支持一键配置的有<code>Amazon EC2 (AMI), DigitalOcean, Docker, Google Compute Engine, OpenStack, QEMU for KVM or Xen instances, or even VirtualBox or VMWare software</code>。</p>
<p>配置只需要一个json就搞定了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// config.json</div><div class="line">&#123;</div><div class="line">  &quot;builders&quot;: [&#123;</div><div class="line">    &quot;type&quot;: &quot;amazon-ebs&quot;,</div><div class="line">    &quot;access_key&quot;: &quot;YOUR KEY HERE&quot;,</div><div class="line">    &quot;secret_key&quot;: &quot;YOUR SECRET KEY HERE&quot;,</div><div class="line">    &quot;region&quot;: &quot;us-east-1&quot;,</div><div class="line">    &quot;source_ami&quot;: &quot;ami-de0d9eb7&quot;,</div><div class="line">    &quot;instance_type&quot;: &quot;t1.micro&quot;,</div><div class="line">    &quot;ssh_username&quot;: &quot;ubuntu&quot;,</div><div class="line">    &quot;ami_name&quot;: &quot;packer-example &quot;</div><div class="line">  &#125;]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后：<code>packer build config.json</code>就搞定了，不得不说是一个: <code>shut up and take my money</code>的东西。</p>
<p>而且这里还是个人的配置，还没说公司的大型的全局的配置的生成和维护呢。</p>
<p>那么好用的东西，还有那么好的doc，还是免费的，明显在用免费的东西打造平台。</p>
<p>公司不错，嗯嗯。</p>

    
  </div>
  <footer>
    
      
      
  <div class="tags">
    <a class="tags-link" href="/tags/vagrant-linux/">vagrant linux</a>
  </div>

    
    <div class="clearfix"></div>
  </footer>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>
  <div class="ds-thread" data-title="vagrantbox制作教程">
  </div>
</section>
</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2016 <a href="/">Maicss</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'maicss' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c252cedcb208dcc2157f54d7108d1cf";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</body>
</html>